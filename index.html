<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!doctype html>
  <html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mordzix — Offline UI</title>
    <style>
      :root{--bg:#071025;--card:#0b1220;--muted:#9aa4b2;--accent:#48b6ff;--radius:12px;--safe-margin:3mm;--max-width:1100px}
      *{box-sizing:border-box}
      html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#04101a);color:#e6eef6}
      .page-wrap{min-height:100vh;padding:var(--safe-margin);display:flex;align-items:center;justify-content:center}
      .app{width:clamp(320px,92vw,var(--max-width));height:clamp(480px,86vh,820px);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:var(--radius);box-shadow:0 6px 30px rgba(0,0,0,0.6);display:grid;grid-template-columns:240px 1fr;grid-template-rows:auto 1fr auto;gap:12px;padding:14px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
      .header{grid-column:1/-1;display:flex;align-items:center;gap:12px;padding:6px 8px}
      .brand{display:flex;align-items:center;gap:10px;font-weight:600;font-size:1.05rem;color:var(--accent)}
      .brand .logo{width:36px;height:36px}
      .sidebar{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.005));border-radius:10px;padding:10px;overflow:auto}
      .endpoint{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}
      .endpoint:hover{background:rgba(255,255,255,0.01);color:#fff}
      .endpoint.active{background:linear-gradient(90deg,rgba(72,182,255,0.12),rgba(72,182,255,0.06));color:#fff}
      .main{display:flex;flex-direction:column;gap:10px;height:100%}
      .messages-wrap{flex:1;overflow:auto;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(0,0,0,0.02),rgba(255,255,255,0.01))}
      .messages{display:flex;flex-direction:column;gap:8px}
      .msg{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)}
      .msg.user{align-self:flex-end;background:linear-gradient(180deg,rgba(72,182,255,0.12),rgba(72,182,255,0.06));color:#00101a}
      .msg.assistant{align-self:flex-start;background:rgba(255,255,255,0.02)}
      .composer{grid-column:1/-1;display:flex;gap:8px;align-items:center}
      .input{flex:1;min-height:44px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;resize:none}
      .btn{background:linear-gradient(180deg,var(--accent),#2aa6e6);padding:10px 12px;border-radius:10px;border:none;color:#042026;cursor:pointer}
      @media (max-width:880px){.app{grid-template-columns:1fr;grid-template-rows:auto 1fr auto}.sidebar{order:3;height:200px}}
    </style>
  </head>
  <body>
    <div class="page-wrap">
      <div class="app" role="application" aria-label="Mordzix Offline UI">
        <header class="header">
          <div class="brand">
            <div class="logo" aria-hidden style="width:36px;height:36px;background:var(--accent);border-radius:8px"></div>
            <div>
              <div style="font-weight:700">Mordzix</div>
              <div style="font-size:0.78rem;color:var(--muted)">Offline / Live hybrid UI</div>
            </div>
          </div>
          <div style="margin-left:auto;color:var(--muted);font-size:0.9rem" id="status">offline</div>
        </header>

        <aside class="sidebar" id="sidebar" aria-label="Lista endpointów">
          <div style="padding:6px 6px 12px 6px;color:var(--muted)">Endpoints</div>
          <div id="endpointsList" tabindex="0"></div>
        </aside>

        <main class="main">
          <div class="messages-wrap" id="messagesWrap" aria-live="polite" aria-label="Obszar wiadomości">
            <div class="messages" id="messages"></div>
          </div>

          <div class="composer" role="form" aria-label="Composer">
            <textarea id="input" class="input" placeholder="Napisz wiadomość..." aria-label="Wiadomość"></textarea>
            <div style="display:flex;flex-direction:column;gap:6px">
              <button id="send" class="btn" title="Wyślij">Wyślij</button>
              <button id="mockToggle" class="btn" title="Toggle live/auto">Live</button>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script>
    (function(){
      // Offline-first UI — no tokens in file, fallback mocks when backend unavailable
      const messagesEl = document.getElementById('messages');
      const messagesWrap = document.getElementById('messagesWrap');
      const inputEl = document.getElementById('input');
      const sendBtn = document.getElementById('send');
      const endpointsList = document.getElementById('endpointsList');
      const statusEl = document.getElementById('status');

      // Embedded minimal manifest
      let ENDPOINTS_MANIFEST = {
        chat: '/api/chat/assistant',
        chat_stream: '/api/chat/assistant/stream',
        files_upload: '/api/files/upload',
        psyche_observe: '/api/psyche/observe',
        psyche_status: '/api/psyche/status',
        tts_speak: '/api/tts/speak',
        research_search: '/api/research/search'
      };

  // live values (populated if server reachable)
  let LIVE_TOKEN = null;
  let IS_LIVE = false;

      function autoScroll(){ requestAnimationFrame(()=> messagesWrap.scrollTop = messagesWrap.scrollHeight); }

      function createMsg(role, text){
        const wrap = document.createElement('div');
        wrap.className = 'msg ' + (role==='user' ? 'user' : 'assistant');
        const c = document.createElement('div'); c.textContent = text; c.style.whiteSpace='pre-wrap';
        wrap.appendChild(c);
        messagesEl.appendChild(wrap);
        autoScroll();
      }

  function setStatus(s){ statusEl.textContent = s; }

  // start locked: disable sending until backend confirms live
  sendBtn.disabled = true;

      // render endpoints in sidebar
      function renderEndpoints(){
        endpointsList.innerHTML = '';
        Object.keys(ENDPOINTS_MANIFEST).forEach(k=>{
          const el = document.createElement('div'); el.className='endpoint'; el.tabIndex=0; el.textContent = k + ' → ' + ENDPOINTS_MANIFEST[k];
          el.addEventListener('click', ()=>{ inputEl.value = k + ': '; inputEl.focus(); });
          endpointsList.appendChild(el);
        });
      }

      // attempt to load live manifest and token
      async function tryLoadLive(){
        try{
          const ctrl = new AbortController();
          const t = setTimeout(()=>ctrl.abort(), 1200);
          const r = await fetch('/api/internal/ui', {signal: ctrl.signal});
          clearTimeout(t);
          if(!r.ok) throw new Error('not ok');
          const j = await r.json();
          if(j && j.manifest){ ENDPOINTS_MANIFEST = Object.assign({}, ENDPOINTS_MANIFEST, j.manifest); }
          if(j && j.token){ LIVE_TOKEN = j.token; }
          IS_LIVE = true; setStatus('live');
          sendBtn.disabled = false;
        }catch(e){ IS_LIVE = false; LIVE_TOKEN = null; setStatus('offline'); }
        renderEndpoints();
        if(!IS_LIVE) sendBtn.disabled = true;
      }

      // simple intent detector
      function detectIntent(text){
        const t = (text||'').toLowerCase();
        if(/pamięć|zapamiętaj|przypomnij/.test(t)) return {endpoint:ENDPOINTS_MANIFEST.psyche_observe, payload:{text}};
        if(/szukaj|wyszukaj|search/.test(t)) return {endpoint:ENDPOINTS_MANIFEST.research_search, payload:{query:text}};
        return {endpoint:ENDPOINTS_MANIFEST.chat, payload:{message:text}};
      }

      async function send(){
        const text = inputEl.value.trim(); if(!text) return; createMsg('user', text); inputEl.value='';
        const intent = detectIntent(text);
        const ep = intent.endpoint || ENDPOINTS_MANIFEST.chat;
        // prefer JSON
        try{
          const headers = {'Content-Type':'application/json'};
          if(LIVE_TOKEN) headers['Authorization'] = `Bearer ${LIVE_TOKEN}`;
          const res = await fetch(ep, {method:'POST', headers, body: JSON.stringify(intent.payload || {message:text})});
          if(res.ok){
            const ct = res.headers.get('content-type')||'';
            if(ct.includes('application/json')){
              const body = await res.json(); const ans = body.answer||body.text||JSON.stringify(body);
              createMsg('assistant', typeof ans==='string'?ans:JSON.stringify(ans, null, 2));
              return;
            }else{
              const t = await res.text(); createMsg('assistant', t); return;
            }
          }
          throw new Error('HTTP '+res.status);
        }catch(err){
          // offline fallback responses
          if(ep.includes('/api/psyche/observe')){
            createMsg('assistant', 'Tryb offline — wiadomość zapisana lokalnie (symulacja).');
          }else if(ep.includes('/api/psyche/status')){
            createMsg('assistant', JSON.stringify({ok:true,memory_loaded:false,note:'offline'},null,2));
          }else if(ep.includes('/api/files/upload')){
            createMsg('assistant', 'Tryb offline — dodano plik lokalnie (symulacja).');
          }else{
            createMsg('assistant', 'Tryb offline — brak połączenia z serwerem.');
          }
        }
      }

      sendBtn.addEventListener('click', send);
      inputEl.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } });

      // toggle live check quickly
      document.getElementById('mockToggle').addEventListener('click', async ()=>{ await tryLoadLive(); });

      // initial render
      renderEndpoints();
      createMsg('assistant', 'Witaj — możesz korzystać offline. Naciśnij Live aby spróbować połączyć się z backendem.');
      // try once at startup
      tryLoadLive();
    })();
    </script>
  </body>
  </html>
          "chat_stream": "/api/chat/assistant/stream",
