<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0a0e17" />
  <link rel="manifest" href="/manifest.webmanifest">
  <title>Mordzix AI â€” Premium</title>
  <style>
    :root {
      --bg: #0a0e17;
      --panel: #0f1422;
      --card: #111a2a;
      --muted: #9aa4b2;
      --text: #e6eef6;
      --accent: #48b6ff;
      --accent-2: #2aa6e6;
      --danger: #ef4444;
      --ok: #22c55e;
      --border: rgba(255,255,255,0.08);
      --radius: 14px;
      --safe: 12px; /* ~3mm wizualnie */
      --maxw: 1200px;
      --shadow: 0 10px 40px rgba(0,0,0,0.45);
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: linear-gradient(180deg, #070c15, #060b12); color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }

    /* Grid: header (fixed), content (messages+side), composer (fixed) */
    .frame { position: fixed; inset: var(--safe); display: grid; grid-template-rows: auto 1fr auto; gap: 10px; max-width: var(--maxw); margin: 0 auto; left: 50%; transform: translateX(-50%); width: calc(100% - var(--safe)*2); }

    .header { height: 60px; display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015)); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
    .brand { display: flex; align-items: center; gap: 12px; font-weight: 600; }
    .logo { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); display: grid; place-items: center; box-shadow: inset 0 0 18px rgba(0,0,0,0.25); }
    .title-wrap { display: flex; flex-direction: column; }
    .title { font-size: 16px; }
    .subtitle { font-size: 12px; color: var(--muted); }
    .spacer { flex: 1; }
    .status { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; background: var(--card); border: 1px solid var(--border); border-radius: 999px; font-size: 12px; color: var(--muted); }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #f59e0b; box-shadow: 0 0 10px #f59e0b; transition: all .2s ease; }

    .content { display: grid; grid-template-columns: 1fr 320px; gap: 10px; min-height: 0; }
    .messages-wrap { position: relative; overflow: hidden; border-radius: var(--radius); border: 1px solid var(--border); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow: var(--shadow); }
    .messages { height: 100%; overflow: auto; padding: 14px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }

    .row { display: flex; gap: 10px; align-items: flex-end; }
    .row.user { justify-content: flex-end; }
    .row.ai { justify-content: flex-start; }

    .avatar { width: 34px; height: 34px; border-radius: 10px; background: var(--panel); border: 1px solid var(--border); display: grid; place-items: center; flex: 0 0 auto; }
    .avatar.ai { background: linear-gradient(135deg, #0f1a2c, #0b1422); }
    .avatar.user { background: linear-gradient(135deg, var(--accent), var(--accent-2)); }

    .bubble { max-width: min(78%, 760px); padding: 12px 14px; border-radius: 14px; border: 1px solid var(--border); background: var(--card); color: var(--text); position: relative; }
    .row.user .bubble { background: linear-gradient(180deg, rgba(72,182,255,0.18), rgba(72,182,255,0.10)); border-color: rgba(72,182,255,0.35); }
    .meta { margin-top: 6px; font-size: 11px; color: var(--muted); display: flex; gap: 10px; }

    .msg-actions { position: absolute; top: 8px; right: 8px; display: flex; gap: 8px; opacity: 0; transition: opacity .15s ease; }
    .bubble:hover .msg-actions { opacity: 1; }
    .icon-btn { width: 28px; height: 28px; display: grid; place-items: center; border-radius: 8px; border: 1px solid var(--border); background: rgba(255,255,255,0.03); color: var(--muted); cursor: pointer; }
    .icon-btn:hover { background: rgba(255,255,255,0.06); color: var(--text); }

    .typing { display: inline-flex; gap: 6px; padding: 10px 12px; }
    .dot-t { width: 6px; height: 6px; border-radius: 999px; background: var(--muted); opacity: .6; animation: t 1.2s ease-in-out infinite; }
    .dot-t:nth-child(2){ animation-delay: .2s; }
    .dot-t:nth-child(3){ animation-delay: .4s; }
    @keyframes t { 0%,60%,100%{ transform: translateY(0); opacity:.6 } 30%{ transform: translateY(-4px); opacity: 1 } }

    .side { border: 1px solid var(--border); border-radius: var(--radius); background: var(--panel); padding: 10px; box-shadow: var(--shadow); display: grid; grid-template-rows: auto auto 1fr; gap: 10px; min-height: 0; }
    .side h3 { margin: 0; font-size: 13px; color: var(--muted); font-weight: 600; }
    .side .group { border: 1px solid var(--border); border-radius: 12px; padding: 10px; background: rgba(255,255,255,0.02); min-height: 0; }

    .endpoints-search { display: flex; gap: 8px; margin-bottom: 8px; }
    .endpoints-search input { flex: 1; background: transparent; border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; color: var(--text); }
    .endpoints-list { overflow: auto; max-height: 38vh; font-size: 12px; }
    .ep { padding: 6px 8px; border-radius: 8px; color: var(--muted); cursor: pointer; display: flex; justify-content: space-between; gap: 8px; }
    .ep:hover { background: rgba(255,255,255,0.05); color: var(--text); }

    .tools { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .tool-btn { padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: rgba(255,255,255,0.03); color: var(--text); font-size: 12px; cursor: pointer; text-align: center; }
    .tool-btn:hover { background: rgba(255,255,255,0.06); }

    .composer { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: end; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--panel); box-shadow: var(--shadow); }
    .toolbox { display: inline-flex; gap: 8px; }
    .btn { height: 40px; min-width: 40px; border-radius: 10px; border: 1px solid var(--border); background: rgba(255,255,255,0.03); display: grid; place-items: center; color: var(--text); cursor: pointer; }
    .btn:hover { background: rgba(255,255,255,0.06); }
    .btn.primary { background: linear-gradient(180deg, var(--accent), var(--accent-2)); border: none; color: #051522; font-weight: 600; padding: 0 14px; }

    .input-wrap { position: relative; }
    textarea { width: 100%; min-height: 40px; max-height: 140px; resize: none; background: transparent; border: 1px solid var(--border); border-radius: 10px; color: var(--text); padding: 10px 12px; font: inherit; outline: none; }
    textarea:focus { border-color: rgba(72,182,255,0.55); box-shadow: 0 0 0 3px rgba(72,182,255,0.15); }

    @media (max-width: 980px){ .content { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="frame" role="application" aria-label="Mordzix Premium UI">
    <header class="header">
      <div class="brand">
        <div class="logo" aria-hidden>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 3l8 4.5v9L12 21l-8-4.5v-9L12 3z" fill="#0a1425"/>
            <path d="M12 5l6 3.4v6.8L12 18l-6-3.4V8.4L12 5z" fill="url(#g)"/>
            <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="#48b6ff"/><stop offset="1" stop-color="#2aa6e6"/></linearGradient></defs>
          </svg>
        </div>
        <div class="title-wrap">
          <div class="title">Mordzix AI</div>
          <div class="subtitle">Premium interfejs Â· Live + Offline</div>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="status"><span class="dot" id="dot"></span><span id="statusText">offline</span></div>
    </header>

    <section class="content">
      <div class="messages-wrap">
        <div class="messages" id="messages" aria-live="polite"></div>
      </div>
      <aside class="side">
        <div class="group">
          <h3>Endpointy</h3>
          <div class="endpoints-search">
            <input id="epSearch" placeholder="Filtruj /api..."/>
            <button class="btn" id="epReload" title="OdÅ›wieÅ¼ listÄ™">â†»</button>
          </div>
          <div class="endpoints-list" id="epList"></div>
        </div>
        <div class="group">
          <h3>TTS & STT</h3>
          <div class="tools">
            <button class="tool-btn" id="ttsBtn" title="Odczytaj ostatniÄ… odpowiedÅº">ðŸ”Š TTS</button>
            <button class="tool-btn" id="micBtn" title="Nagraj i rozpoznaj">ðŸŽ¤ STT</button>
            <select id="voiceSel" class="tool-btn" style="grid-column: span 2; text-align:left;"></select>
          </div>
        </div>
        <div class="group">
          <h3>Pliki</h3>
          <div class="tools">
            <button class="tool-btn" id="fileBtn">ðŸ“Ž ZaÅ‚Ä…cz</button>
            <button class="tool-btn" id="filesListBtn">ðŸ“‚ Lista</button>
          </div>
          <input type="file" id="fileInput" hidden />
          <div id="filesOut" style="margin-top:8px; font-size:12px; color:var(--muted); max-height:24vh; overflow:auto;"></div>
        </div>
      </aside>
    </section>

    <footer class="composer" aria-label="Wpisz wiadomoÅ›Ä‡">
      <div class="toolbox">
        <button class="btn" id="showEndpoints" title="PokaÅ¼ endpointy">â˜°</button>
      </div>
      <div class="input-wrap">
        <textarea id="input" placeholder="Napisz wiadomoÅ›Ä‡... (Enter: wyÅ›lij, Shift+Enter: nowa linia)"></textarea>
      </div>
      <div class="toolbox">
        <button class="btn primary" id="sendBtn" title="WyÅ›lij">WyÅ›lij</button>
      </div>
    </footer>
  </div>

  <script>
  (function(){
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const statusText = document.getElementById('statusText');
    const dotEl = document.getElementById('dot');

    const epListEl = document.getElementById('epList');
    const epSearchEl = document.getElementById('epSearch');
    const epReloadBtn = document.getElementById('epReload');
    const showEndpointsBtn = document.getElementById('showEndpoints');

    const ttsBtn = document.getElementById('ttsBtn');
    const micBtn = document.getElementById('micBtn');
    const voiceSel = document.getElementById('voiceSel');

    const fileBtn = document.getElementById('fileBtn');
    const fileInput = document.getElementById('fileInput');
    const filesListBtn = document.getElementById('filesListBtn');
    const filesOut = document.getElementById('filesOut');

    let LIVE_TOKEN = null;
    let IS_LIVE = false;
    let userId = 'user_' + Math.floor(Date.now()/1000);
    const allMessages = [];

    function autoScroll(){ requestAnimationFrame(()=>{ messagesEl.scrollTop = messagesEl.scrollHeight; }); }
    function setStatus(live){ IS_LIVE = !!live; statusText.textContent = live ? 'live' : 'offline'; dotEl.style.background = live ? '#22c55e' : '#f59e0b'; dotEl.style.boxShadow = live ? '0 0 10px #22c55e' : '0 0 10px #f59e0b'; sendBtn.disabled = !live; }

    function makeRow(role, text){
      const row = document.createElement('div'); row.className = 'row ' + (role==='user'?'user':'ai');
      const avatar = document.createElement('div'); avatar.className = 'avatar ' + (role==='user'?'user':'ai');
      avatar.innerHTML = role==='user'
        ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="#051522" xmlns="http://www.w3.org/2000/svg"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"/></svg>'
        : '<svg width="16" height="16" viewBox="0 0 24 24" fill="#48b6ff" xmlns="http://www.w3.org/2000/svg"><path d="M12 3l8 4.5v9L12 21l-8-4.5v-9L12 3z"/></svg>';
      const bubble = document.createElement('div'); bubble.className = 'bubble';
      const content = document.createElement('div'); content.style.whiteSpace = 'pre-wrap'; content.textContent = text;
      const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = new Date().toLocaleTimeString('pl-PL',{hour:'2-digit',minute:'2-digit'});
      const actions = document.createElement('div'); actions.className = 'msg-actions';
      const copyBtn = document.createElement('button'); copyBtn.className='icon-btn'; copyBtn.title='Kopiuj'; copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 9h11v11H9z" stroke="currentColor" stroke-width="1.6"/><path d="M4 4h11v11H4z" stroke="currentColor" stroke-width="1.6"/></svg>';
      copyBtn.onclick = async ()=>{ try{ await navigator.clipboard.writeText(text); copyBtn.style.color = '#48b6ff'; setTimeout(()=>copyBtn.style.color='',600);}catch(e){} };
      actions.appendChild(copyBtn);
      bubble.appendChild(actions);
      bubble.appendChild(content);
      bubble.appendChild(meta);
      if(role==='user'){ row.appendChild(bubble); row.appendChild(avatar);} else { row.appendChild(avatar); row.appendChild(bubble);}    
      return row;
    }

    function addMessage(role, text){ allMessages.push({ role, content: text }); const row = makeRow(role, text); messagesEl.appendChild(row); autoScroll(); }

    let typingRow = null;
    function showTyping(){ if(typingRow) return; typingRow=document.createElement('div'); typingRow.className='row ai'; const b=document.createElement('div'); b.className='bubble'; const t=document.createElement('div'); t.className='typing'; t.innerHTML='<span class="dot-t"></span><span class="dot-t"></span><span class="dot-t"></span>'; b.appendChild(t); typingRow.appendChild(document.createElement('div')).className='avatar ai'; typingRow.appendChild(b); messagesEl.appendChild(typingRow); autoScroll(); }
    function hideTyping(){ if(typingRow){ typingRow.remove(); typingRow=null; } }

    async function initLive(){
      try { const c = new AbortController(); const to = setTimeout(()=>c.abort(), 1200); let r = await fetch('/api/internal/ui', { signal: c.signal }); clearTimeout(to); if(!r.ok) throw 0; const j = await r.json(); if(j && j.token){ LIVE_TOKEN = j.token; setStatus(true);} else setStatus(false); }
      catch(e){ try{ const r2 = await fetch('/api/internal/ui_token'); if(r2.ok){ const j2 = await r2.json(); if(j2 && j2.token){ LIVE_TOKEN=j2.token; setStatus(true);} else setStatus(false);} else setStatus(false);} catch(_){ setStatus(false);} }
      if(IS_LIVE){ loadVoices(); loadEndpoints(); }
    }

    async function loadVoices(){ try{ const r=await fetch('/api/tts/voices'); if(!r.ok) return; const j=await r.json(); voiceSel.innerHTML=''; (j.voices||['rachel']).forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; if(j.default===v) o.selected=true; voiceSel.appendChild(o); }); }catch(e){} }

    async function loadEndpoints(){ try{ const r=await fetch('/api/endpoints/list'); if(!r.ok) return; const j=await r.json(); renderEndpoints(j.endpoints||[]);} catch(e){} }

    function renderEndpoints(list){ epListEl.innerHTML=''; const q=(epSearchEl.value||'').toLowerCase(); list.filter(x=> x.path && x.path.toLowerCase().includes(q)).slice(0,400).forEach(ep=>{ const el=document.createElement('div'); el.className='ep'; const m=(ep.methods||[]).join(','); el.innerHTML='<span>'+ep.path+'</span><span>'+m+'</span>'; el.onclick=()=> openEndpoint(ep); epListEl.appendChild(el); }); }

    async function openEndpoint(ep){
      const m = prompt('Metoda ['+(ep.methods||[]).join(',')+']', (ep.methods||[])[0]||'GET'); if(!m) return;
      let body = null; if(m.toUpperCase()!=='GET'){ body = prompt('JSON body', '{"sample":true}'); }
      const headers = {}; if(LIVE_TOKEN) headers['Authorization']='Bearer '+LIVE_TOKEN; if(body) headers['Content-Type']='application/json';
      try{ const r = await fetch(ep.path, { method: m, headers, body }); const ct = r.headers.get('content-type')||''; const out = ct.includes('application/json')? JSON.stringify(await r.json(), null, 2): await r.text(); addMessage('ai', 'Endpoint '+ep.path+'\n'+out.slice(0,4000)); }catch(e){ addMessage('ai', 'BÅ‚Ä…d endpointu '+ep.path); }
    }

    async function send(){ const text=(inputEl.value||'').trim(); if(!text || !IS_LIVE) return; addMessage('user', text); inputEl.value=''; inputEl.style.height='auto'; showTyping();
      const headers = { 'Content-Type':'application/json' }; if(LIVE_TOKEN) headers['Authorization']='Bearer '+LIVE_TOKEN;
      const payload = { messages: allMessages.map(m=>({role:m.role, content:m.content})), user_id: userId, use_memory:true, use_research:true, internet_allowed:true, auto_learn:true };
      // Prefer stream
      try{
        const r = await fetch('/api/chat/assistant/stream', { method:'POST', headers, body: JSON.stringify(payload) });
        if(r.ok && (r.headers.get('content-type')||'').includes('text/event-stream')){
          let acc=''; const reader = r.body.getReader(); const decoder = new TextDecoder();
          while(true){ const {value, done} = await reader.read(); if(done) break; const chunk = decoder.decode(value, {stream:true}); acc += chunk; const lines=chunk.split('\n'); for(const line of lines){ if(line.startsWith('data: ')){ try{ const evt = JSON.parse(line.slice(6)); if(evt.type==='chunk' && evt.content){ if(typingRow){ const txt = (document.querySelector('.row.ai:last-child .bubble div[style]')?.textContent || ''); } } }catch(e){} } }
          }
          hideTyping(); // Final fallback: call non-stream to get full
          try{ const r2 = await fetch('/api/chat/assistant', { method:'POST', headers, body: JSON.stringify(payload)}); if(r2.ok){ const j=await r2.json(); addMessage('ai', j.answer || JSON.stringify(j)); } else addMessage('ai','BÅ‚Ä…d: '+r2.status); }catch(e){ addMessage('ai','BÅ‚Ä…d poÅ‚Ä…czenia.'); }
          return;
        }
        // If not SSE, fallback to normal
        hideTyping(); const j = await r.json().catch(()=>null); if(j && (j.answer||j.text)){ addMessage('ai', j.answer||j.text); } else { addMessage('ai', 'BÅ‚Ä…d: '+r.status); }
      }catch(err){ hideTyping(); addMessage('ai','BÅ‚Ä…d poÅ‚Ä…czenia.'); }
    }

    // Controls
    inputEl.addEventListener('input', ()=>{ inputEl.style.height='auto'; inputEl.style.height=Math.min(inputEl.scrollHeight,140)+'px'; });
    inputEl.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } });
    sendBtn.addEventListener('click', send);

    epReloadBtn.addEventListener('click', loadEndpoints);
    epSearchEl.addEventListener('input', ()=>{ loadEndpoints(); });
    showEndpointsBtn.addEventListener('click', ()=>{ document.querySelector('.content').scrollTo({ top: 0, behavior: 'smooth' }); });

    // Files
    fileBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', async (e)=>{ const f=e.target.files && e.target.files[0]; if(!f) return; try { const fd = new FormData(); fd.append('file', f); const headers={}; if(LIVE_TOKEN) headers['Authorization']='Bearer '+LIVE_TOKEN; const r=await fetch('/api/files/upload', { method:'POST', headers, body: fd }); const j=await r.json(); if(j.ok){ addMessage('ai', `Dodano plik: ${j.filename} (${Math.round((j.size||0)/1024)} KB)`);} else addMessage('ai','Upload nieudany'); }catch(_){ addMessage('ai','Upload bÅ‚Ä…d.'); } e.target.value=''; });
    filesListBtn.addEventListener('click', async ()=>{ try{ const headers={}; if(LIVE_TOKEN) headers['Authorization']='Bearer '+LIVE_TOKEN; const r=await fetch('/api/files/list', {headers}); const j=await r.json(); filesOut.textContent = (j.files||[]).map(x=> `${x.file_id||x.id}  ${x.name||''}  ${Math.round((x.size||0)/1024)}KB`).join('\n') || 'brak plikÃ³w'; }catch(_){ filesOut.textContent='bÅ‚Ä…d listy'; } });

    // STT
    let mediaRec=null, recChunks=[];
    micBtn.addEventListener('click', async ()=>{ try{ if(!location.protocol.startsWith('https')){ alert('STT wymaga HTTPS (przeglÄ…darka).'); return; } const s=await navigator.mediaDevices.getUserMedia({audio:true}); if(!mediaRec){ mediaRec=new MediaRecorder(s); mediaRec.ondataavailable=(e)=> recChunks.push(e.data); mediaRec.onstop=async ()=>{ const blob = new Blob(recChunks, {type:'audio/webm'}); recChunks=[]; const fd=new FormData(); fd.append('audio', blob, 'audio.webm'); const headers={}; if(LIVE_TOKEN) headers['Authorization']='Bearer '+LIVE_TOKEN; try{ const r=await fetch('/api/stt/transcribe',{method:'POST',headers,body:fd}); const j=await r.json(); if(j && j.ok && j.text){ inputEl.value += (inputEl.value?' ':'') + j.text; inputEl.dispatchEvent(new Event('input')); } }catch(e){} }; }
      if(mediaRec.state!=='recording'){ mediaRec.start(); setTimeout(()=>{ if(mediaRec && mediaRec.state==='recording') mediaRec.stop(); }, 3500);} }catch(e){ alert('Brak dostÄ™pu do mikrofonu'); } });

    // TTS
    ttsBtn.addEventListener('click', async ()=>{ const lastAi=[...allMessages].reverse().find(m=>m.role==='ai'); if(!lastAi) return; const headers={'Content-Type':'application/json'}; if(LIVE_TOKEN) headers['Authorization']='Bearer '+LIVE_TOKEN; const body={ text: lastAi.content, voice: (voiceSel.value||'rachel') }; try{ const r=await fetch('/api/tts/speak',{method:'POST',headers,body:JSON.stringify(body)}); if(!r.ok){ addMessage('ai','TTS bÅ‚Ä…d: '+r.status); return;} const buf=await r.arrayBuffer(); const blob=new Blob([buf],{type:'audio/mpeg'}); const url=URL.createObjectURL(blob); new Audio(url).play(); }catch(e){ addMessage('ai','TTS poÅ‚Ä…czenie nieudane'); } });

    // Init
    addMessage('ai','CzeÅ›Ä‡! Premium Mordzix online. Napisz coÅ›, a ogarnÄ™.');
    initLive();

    // PWA
    if('serviceWorker' in navigator){ try{ navigator.serviceWorker.register('/sw.js'); }catch(e){} }
  })();
  </script>
</body>
</html>
